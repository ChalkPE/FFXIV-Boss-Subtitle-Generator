<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>FFXIV Boss Subtitle Generator</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.1.7/dist/css/uikit.min.css" integrity="sha256-1NCiLO1eL8xsDn3wFHlM37FhxQjBruKz/veyTbWSWHk=" crossorigin="anonymous">
    <style>
        [v-cloak] {
            display: none;
        }

        canvas {
            width: 90vw;
        }

        @font-face {
            font-family: 'Yu Mincho Demibold';
            src: local('Yu Mincho Demibold');
        }
    </style>
</head>

<body>
    <header class="uk-section-xsmall uk-section-default uk-box-shadow-small" uk-sticky="show-on-up: true; animation: uk-aimation-slide-top;">
        <div class="uk-container uk-container-expand">
            <nav class="uk-navbar-container uk-navbar-transparent" uk-navbar>
                <div class="uk-navbar-left"></div>
                <div class="uk-navbar-center"><a class="uk-navbar-item" href="#">FFXIV Boss Subtitle Generator</a></div>
                <div class="uk-navbar-right"></div>
            </nav>
        </div>
    </header>
    <main class="uk-margin-left uk-margin-right" id="app" v-cloak>
        <section class="uk-section uk-padding-small" id="s-file">
            <h1 class="uk-h1">画像選択</h1>
            <div class="uk-form-custom">
                <input type="file" accept="image/png, image/jpeg" @change="fileSelected" />
                <button class="uk-button uk-button-default" type="button" tabindex="-1">
                    <span uk-icon="icon: upload"></span>
                    使用する画像ファイルを選択
                </button>
            </div>
            <span class="uk-text-middle uk-margin-left">{{ file !== null ? file.name : '選択されていません' }}</span>
        </section>
        <section class="uk-section uk-padding-small" id="s-data" v-show="isImageSelected">
            <h1 class="uk-h1">テキスト入力</h1>
            <div class="uk-form-stacked">
                <div>
                    <input class="uk-input" id="subtitle-upper" type="text" placeholder="1行目" v-model="subtitles.upper" />
                </div>
                <div>
                    <input class="uk-input" id="subtitle-lower" type="text" placeholder="2行目" v-model="subtitles.lower" />
                </div>
            </div>
        </section>
        <section class="uk-section uk-padding-small" id="s-result" v-show="isImageSelected">
            <h1 class="uk-h1">生成結果</h1>
            <div class="uk-form-custom">
                <button class="uk-button uk-button-primary" @click="downloadImage">
                    <span uk-icon="icon: download"></span>
                    画像をダウンロード
                </button>
            </div>
            <a id="download-image" target="_blank" download style="display: none;">download</a>
            <div class="uk-align-center" id="s-result-container">
                <canvas id="result" :width="resultCanvas.width" :height="resultCanvas.height"></canvas>
            </div>
        </section>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/uikit@3.1.7/dist/js/uikit.min.js" integrity="sha256-Si/RSqVaI2Nt0NBCIADY5gtwKd6MVxsARUchEjnOoh4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/uikit@3.1.7/dist/js/uikit-icons.min.js" integrity="sha256-xx24qw2IGUl97Dv7hUvw9UKnw2G7iVq+MmE4nkM/WJs=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.min.js" integrity="sha256-chlNFSVx3TdcQ2Xlw7SvnbLAavAQLO0Y/LBiWX04viY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/createjs@1.0.1/builds/1.0.0/createjs.min.js" integrity="sha256-2wdA6xeHmnRYyJJeIH/YDKhCT4DdzeLN+8T39bRO7R0=" crossorigin="anonymous"></script>
    <script>
        const cjs = createjs;
        const app = new Vue({
            el: '#app',
            data: {
                isImageSelected: false,
                resultCanvas: {
                    width: 0,
                    height: 0,
                },
                file: null,
                image: null,
                subtitles: {
                    upper: '',
                    lower: '',
                },
            },
            computed: {
                subtitleUpper: function () {
                    return this.subtitles.upper.split('').join(' ');
                },
                subtitleLower: function () {
                    return this.subtitles.lower.split('').join(' ');
                },
            },
            watch: {
                image: function (val, oldVal) {
                    if (val != null) {
                        this.isImageSelected = true;
                    } else {
                        this.isImageSelected = false;
                    }
                },
                subtitles: {
                    handler: function (val, oldVal) {
                        this.drawCanvas();
                    },
                    deep: true,
                },
                file: function (val, oldVal) {
                    // 選択されたファイルの Blob URL を取得する
                    let src = window.URL.createObjectURL(this.file);
                    // 画像を読み込む
                    this.loadImage(src);
                },
            },
            mounted: function () {
                // Stage
                this.stage = new cjs.Stage(this.$el.children['s-result'].children["s-result-container"].children['result']);
                cjs.Ticker.addEventListener('tick', this.stage);
            },
            methods: {
                fileSelected: function (e) {
                    e.preventDefault();
                    // 選択されたファイルの情報を取得
                    let file = e.target.files[0];
                    if (file === undefined) {
                        // キャンセルされた場合は何もしない
                        return;
                    }
                    this.file = file;
                },
                loadImage: function (src) {
                    console.log('loadImage():', 'src=' + src);
                    let image = new Image();
                    image.onload = () => {
                        // キャンバスサイズを画像に合わせる
                        this.resultCanvas.width = image.naturalWidth;
                        this.resultCanvas.height = image.naturalHeight;
                    };
                    image.src = src;
                    this.image = image;
                    // キャンバスを初期化
                    this.resetCanvas();
                },
                drawCanvas: function () {
                    this.resetCanvas();
                    this.drawSubtitleLine();
                    this.drawSubtitleUpper();
                    this.drawSubtitleLower();
                },
                resetCanvas: function () {
                    // Stage の子要素をクリア
                    this.stage.removeAllChildren();
                    // 参照画像を追加
                    this.stage.addChild(new cjs.Bitmap(this.image));
                },
                drawSubtitleLine: function () {
                    // 線の長さ・大きさ
                    let lineLength = parseInt(this.resultCanvas.width * (2.5 / 4.5));
                    let lineSize = 3;
                    // 線の位置
                    let left = parseInt(this.resultCanvas.width * (1.0 / 4.5));
                    let top = parseInt(this.resultCanvas.height * (2.5 / 3.5) - Math.floor(lineSize / 2));

                    // 線の影
                    let g1 = new cjs.Graphics();
                    g1.beginStroke('black')
                        .setStrokeStyle(lineSize + 2)
                        .moveTo(left - 1, top)
                        .lineTo(left + lineLength + 1, top)
                        .endStroke();
                    let s1a = new cjs.Shape(g1);
                    let s1b = new cjs.Shape(g1);
                    s1a.shadow = new cjs.Shadow('black', 0, 0, (lineSize + 2) * 2);
                    s1b.shadow = new cjs.Shadow('black', 0, 0, (lineSize + 2) * 2);

                    //// 線の影を濃くするため2度描画する
                    this.stage.addChild(s1a);
                    //this.stage.addChild(s1b);

                    // 線の本体
                    let g2 = new cjs.Graphics();
                    g2.beginStroke('white')
                        .setStrokeStyle(lineSize)
                        .moveTo(left, top)
                        .lineTo(left + lineLength, top)
                        .endStroke();
                    let s2 = new cjs.Shape(g2);

                    // 線を描画する
                    this.stage.addChild(s2);
                },
                drawSubtitleUpper: function () {
                    // フォント
                    let fontFamily = 'Yu Mincho Demibold';
                    let fontSize = 48;
                    let font = fontSize + 'px ' + fontFamily;
                    // 文字の位置
                    let left = parseInt(this.resultCanvas.width / 2);
                    let top = parseInt(this.resultCanvas.height * (2.5 / 3.5) - fontSize);

                    // 文字の影
                    var t1 = new cjs.Text(this.subtitleUpper, font, 'black');
                    t1.x = left;
                    t1.y = top;
                    t1.textAlign = 'center';
                    t1.textBaseline = 'middle';
                    t1.shadow = new cjs.Shadow('black', 0, 0, fontSize / 4);

                    this.stage.addChild(t1);

                    // 文字
                    var t2 = new cjs.Text(this.subtitleUpper, font, 'white');
                    t2.x = left;
                    t2.y = top;
                    t2.textAlign = 'center';
                    t2.textBaseline = 'middle';
                    t2.shadow = new cjs.Shadow('black', 0, 0, fontSize / 4);

                    this.stage.addChild(t2);
                },
                drawSubtitleLower: function () {
                    // フォント
                    let fontFamily = 'Yu Mincho Demibold';
                    let fontSize = 48;
                    let font = fontSize + 'px ' + fontFamily;
                    // 文字の位置
                    let left = parseInt(this.resultCanvas.width / 2);
                    let top = parseInt(this.resultCanvas.height * (2.5 / 3.5) + fontSize);

                    // 文字の影
                    var t1 = new cjs.Text(this.subtitleLower, font, 'black');
                    t1.x = left;
                    t1.y = top;
                    t1.textAlign = 'center';
                    t1.textBaseline = 'middle';
                    t1.shadow = new cjs.Shadow('black', 0, 0, fontSize / 4);

                    this.stage.addChild(t1);

                    // 文字
                    var t2 = new cjs.Text(this.subtitleLower, font, 'white');
                    t2.x = left;
                    t2.y = top;
                    t2.textAlign = 'center';
                    t2.textBaseline = 'middle';
                    t2.shadow = new cjs.Shadow('black', 0, 0, fontSize / 4);

                    this.stage.addChild(t2);
                },
                downloadImage: function (e) {
                    //
                    let cv = document.getElementById('result');
                    let lk = document.getElementById('download-image');
                    lk.href = cv.toDataURL();
                    lk.click();
                },
            },
        })
    </script>
</body>

</html>
